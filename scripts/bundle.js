(()=>{var m=(r,t,e)=>new Promise((i,s)=>{var n=f=>{try{d(e.next(f))}catch(D){s(D)}},c=f=>{try{d(e.throw(f))}catch(D){s(D)}},d=f=>f.done?i(f.value):Promise.resolve(f.value).then(n,c);d((e=e.apply(r,t)).next())});window.addLoadEventListener=function(r){let t=!1,e=()=>{t||(t=!0,r())};window.addEventListener("DOMContentLoaded",e),window.addEventListener("load",e),document.addEventListener("load",e),window.addEventListener("ready",e),setTimeout(e,1e3)};window.addVisibilityChangeEventListener=function(r){let t=["webkit","moz","ms",""],e=!1,i=()=>{if(e)return;e=!0;let s=t.map(n=>n&&n.length>0?`${n}Hidden`:"hidden").map(n=>document[n]).reduce((n,c)=>n||c,!1);setTimeout(()=>{r(!s),e=!1},0)};for(let s of t)document.addEventListener(`${s}visibilitychange`,i);document.onvisibilitychange=i};HTMLCanvasElement.prototype.screenshot=function(r="download.png"){let t=document.createElement("a");t.download=r,t.href=this.toDataURL("image/png;base64"),t.style.visibility="hidden",t.style.display="none",document.body.appendChild(t),setTimeout(()=>{t.click(),document.body.removeChild(t)},100)};String.prototype.toCamelCase=function(){return this.replace("--","").replace(/-./g,r=>r[1].toUpperCase()).trim()};Array.prototype.remove=function(r){let t=this.indexOf(r);return t!=-1?(this.splice(t,1),!0):!1};Array.prototype.appendArray=function(r){if(!!r)for(let t=0;t<r.length;t++)this.push(r[t])};Math.clamp=function(r,t,e){return Math.min(Math.max(r,t),e)};Math.average=function(...r){return r.reduce((t,e)=>t+e,0)/r.length};Math.distance=function(r,t,e,i){return Math.sqrt(Math.pow(e-r,2)+Math.pow(i-t,2))};Math.randomInt=function(r,t){return Math.floor(Math.random()*(t-r+1))+r};CanvasRenderingContext2D.prototype.clear=function(){this.clearRect(0,0,this.canvas.width,this.canvas.height)};CanvasRenderingContext2D.prototype.line=function(r,t,e,i){this.beginPath(),this.moveTo(r,t),this.lineTo(e,i),this.stroke()};Promise.delay=function(r){return new Promise((t,e)=>{setTimeout(t,r)})};var h=class{static logColoredText(t,e,i,...s){console[t].call(console,`%c${t.toUpperCase()} %c[${e}]`,`font-weight: bold; color: ${i};`,"font-weight: bold; color: gray",...s)}static info(t,...e){this.logColoredText("info",t,"turquoise",...e)}static warn(t,...e){this.logColoredText("warn",t,"yellow",...e)}static error(t,...e){this.logColoredText("error",t,"red",...e)}static debug(t,...e){}};var L=class{static alpha(t,e){let i=t;i.startsWith("#")&&(i=i.slice(1)),i.length===3&&(i=i.replace(/./g,"$&$&"));let s=Math.round(e*255).toString(16).padStart(2,"0");return`#${i}${s}`}static interpolate(t,e,i){let s=`0x${t.trim().slice(1)}`,n=`0x${e.trim().slice(1)}`;s.length<5&&(s=s.replace(/./g,"$&$&")),n.length<5&&(n=n.replace(/./g,"$&$&"));let c=parseInt(s,16),d=parseInt(n,16),f=c>>16,D=c>>8&255,Z=c&255,et=d>>16,it=d>>8&255,st=d&255,rt=Math.round(f+(et-f)*i),nt=Math.round(D+(it-D)*i),ot=Math.round(Z+(st-Z)*i);return`#${(16777216+(rt<<16)+(nt<<8)+ot).toString(16).slice(1)}`}static isColorLight(t){let e=`0x${t.trim().slice(1)}`;e.length<5&&(e=e.replace(/./g,"$&$&"));let i=parseInt(e,16),s=i>>16,n=i>>8&255,c=i&255;return Math.sqrt(.299*(s*s)+.587*(n*n)+.114*(c*c))>127.5}};var v=class{static setup(t){return m(this,null,function*(){v.main=t,v.loadVariables(),v.observeChanges()})}static loadVariables(){let t=["--background","--foreground","--container-background","--container-border","--container-shadow","--cell-alive","--cell-dead"];h.info("Theme",`Setting up theme, loading ${t.length} variables...`),console.groupCollapsed("Loading theme variables");let e=getComputedStyle(document.body);for(let i of t){let s=e.getPropertyValue(i),n=i.toString().toCamelCase();v[n]=s,console.log(`%c${n}`,`color: ${L.isColorLight(s)?"#212121":"#eee"}; background-color: ${s}`)}console.groupEnd()}static observeChanges(){let t=window.matchMedia("(prefers-color-scheme: dark)");t.addEventListener("change",()=>{h.info("Theme",`Changed theme to ${t.matches?"dark":"light"}`),v.loadVariables()})}};var a=class{constructor(t,e){this.x=t,this.y=e}dot(t){return this.x*t.x+this.y*t.y}add(t){return new a(this.x+t.x,this.y+t.y)}subtract(t){return new a(this.x-t.x,this.y-t.y)}multiply(t){return new a(this.x*t,this.y*t)}divide(t){return new a(this.x/t,this.y/t)}normalize(){let t=this.length;return new a(this.x/t,this.y/t)}clone(){return new a(this.x,this.y)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}static get zero(){return new a(0,0)}toString(){return`{ ${this.x}, ${this.y} }`}};var p=class{constructor(t,e,i,s){this.x=t;this.y=e;this.width=i;this.height=s}translate(t){return new p(this.x+t.x,this.y+t.y,this.width,this.height)}contains(t,e=void 0){if(t instanceof a&&e===void 0)return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y;if(t instanceof p&&e===void 0)return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height;if(typeof t=="number"&&typeof e=="number")return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height;throw new Error("Invalid arguments")}intersects(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y}intersection(t){let e=Math.max(this.x,t.x),i=Math.max(this.y,t.y),s=Math.min(this.x+this.width,t.x+t.width)-e,n=Math.min(this.y+this.height,t.y+t.height)-i;return new p(e,i,s,n)}get size(){return new a(this.width,this.height)}get position(){return new a(this.x,this.y)}get center(){return new a(this.x+this.width/2,this.y+this.height/2)}clone(){return new p(this.x,this.y,this.width,this.height)}equals(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}toString(){return`{ x: ${this.x}, y: ${this.y}, width: ${this.width}, height: ${this.height} }`}};var T=class{constructor(t=void 0){this.element=document.createElement("canvas");this.virtualWidth=0;this.virtualHeight=0;this.drawRatio=1;this.overrideRatio=void 0;t&&(this.element.id=t);let e=this.element.getContext("2d");if(!e)throw new Error("Could not get context of canvas");this.context=e,this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.element.oncontextmenu=()=>!1}get backingStoreRatio(){return this.overrideRatio||this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1}get devicePixelRation(){return this.overrideRatio||window.devicePixelRatio||1}getDrawRatio(t,e){return e/t}setSize(t,e){this.drawRatio=this.getDrawRatio(this.backingStoreRatio,this.devicePixelRation),this.backingStoreRatio!==this.devicePixelRation?(this.element.width=t*this.drawRatio,this.element.height=e*this.drawRatio,this.element.style.width=`${t}px`,this.element.style.minWidth=`${t}px`,this.element.style.height=`${e}px`,this.element.style.minHeight=`${e}px`):(this.element.width=t,this.element.height=e,this.element.style.width="",this.element.style.height=""),this.context.scale(this.drawRatio,this.drawRatio),this.virtualWidth=t,this.virtualHeight=e}clear(){this.context.clearRect(0,0,this.element.width,this.element.height)}drawTo(t,e,i){i.save(),i.scale(1/this.drawRatio,1/this.drawRatio),i.drawImage(this.element,t,e),i.restore()}attachToElement(t){t.appendChild(this.element)}get width(){return this.virtualWidth||this.element.width}get height(){return this.virtualHeight||this.element.height}get bounds(){return new p(0,0,this.width,this.height)}};var u=class{static isKeyDown(...t){return t.some(e=>this.keys[e])}static isKeyJustPressed(...t){return t.some(e=>this.keysJustPressed[e])}static onKeyDown(t){this.keys[t.key]=!0,this.keysJustPressed[t.key]=!0}static onKeyUp(t){this.keys[t.key]=!1,delete this.keysJustPressed[t.key]}static isMouseButtonDown(...t){return t.some(e=>this.mouseButtons[e])}static isMouseButtonJustPressed(...t){return t.some(e=>this.mouseButtonsJustPressed[e])}static isMouseButtonJustReleased(...t){return t.some(e=>this.mouseButtonsJustReleased[e])}static onMouseMove(t){var e,i,s,n;this.mouseDelta.x=t.movementX,this.mouseDelta.y=t.movementY,this.mouse.x=t.clientX-((i=(e=t.target)==null?void 0:e.offsetLeft)!=null?i:0),this.mouse.y=t.clientY-((n=(s=t.target)==null?void 0:s.offsetTop)!=null?n:0)}static onMouseDown(t){this.mouseButtons[t.button]=!0,this.mouseButtonsJustPressed[t.button]=!0}static onMouseUp(t){this.mouseButtons[t.button]=!1,this.mouseButtonsJustReleased[t.button]=!0}static onPointerDown(t,e){console.log("Pointer down",e),this.mouseButtons[e.button]=!0,this.mouseButtonsJustPressed[e.button]=!0,t.setPointerCapture(e.pointerId)}static onPointerUp(t,e){console.log("Pointer up",e),this.mouseButtons[e.button]=!1,this.mouseButtonsJustReleased[e.button]=!0,t.releasePointerCapture(e.pointerId)}static setup(t){window.addEventListener("keydown",this.onKeyDown.bind(this)),window.addEventListener("keyup",this.onKeyUp.bind(this)),t.canvas.element.addEventListener("click",this.onMouseMove.bind(this)),t.canvas.element.addEventListener("mousemove",this.onMouseMove.bind(this)),t.canvas.element.addEventListener("mousedown",this.onMouseDown.bind(this)),t.canvas.element.addEventListener("mouseup",this.onMouseUp.bind(this)),t.canvas.element.addEventListener("pointermove",this.onMouseMove.bind(this)),t.canvas.element.addEventListener("pointerdown",this.onPointerDown.bind(this,t.canvas.element)),t.canvas.element.addEventListener("pointerup",this.onPointerUp.bind(this,t.canvas.element))}static update(){this.keysJustPressed={},this.mouseButtonsJustPressed={},this.mouseButtonsJustReleased={}}};u.keys={},u.keysJustPressed={},u.mouse=a.zero,u.mouseDelta=a.zero,u.mouseButtons={},u.mouseButtonsJustPressed={},u.mouseButtonsJustReleased={};var j={EASY:{columns:9,rows:9,bombs:10,name:"Easy"},MEDIUM:{columns:16,rows:16,bombs:40,name:"Medium"},HARD:{columns:30,rows:16,bombs:99,name:"Hard"}},F=3;var b=2,g=10*b,l=3*b,E=1*b,x=3*b,M=2*b,Q=2*b,H=20*b,k=H*2,B="rgb(184, 184, 184)",P="rgb(255, 255, 255)",w="rgb(117, 117, 117)",tt="rgb(0, 0, 0)";function S(r,t,e=2){z(r,t,e,P,w,B)}function I(r,t,e=2){z(r,t,e,w,P,B)}function z(r,t,e=2,i,s,n){r.fillStyle=i,r.beginPath(),r.moveTo(t.x,t.y),r.lineTo(t.x+t.width,t.y),r.lineTo(t.x+t.width-e,t.y+e),r.lineTo(t.x+e,t.y+t.height-e),r.lineTo(t.x,t.y+t.height),r.closePath(),r.fill(),r.fillStyle=s,r.beginPath(),r.moveTo(t.x+t.width,t.y+t.height),r.lineTo(t.x,t.y+t.height),r.lineTo(t.x+e,t.y+t.height-e),r.lineTo(t.x+t.width-e,t.y+e),r.lineTo(t.x+t.width,t.y),r.closePath(),r.fill(),r.fillStyle=n,r.fillRect(t.x+e,t.y+e,t.width-e*2,t.height-e*2)}var o=class{constructor(t,e=!0,i=void 0){this.url=t;this.pixelated=e;this.size={width:0,height:0};i&&(this.size=i)}setup(){return m(this,null,function*(){this.image=new Image,this.image.src=this.url,yield this.image.decode(),this.size={width:this.image.width,height:this.image.height}})}render(t,e,i,s=this.size.width,n=this.size.height){t.save(),this.pixelated&&(t.imageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1,t.msImageSmoothingEnabled=!1,t.oImageSmoothingEnabled=!1),t.drawImage(this.image,e,i,s,n),t.restore()}};var A=class{constructor(t,e=3){this.displaySize=e;this.sprites=[new o("assets/images/digit0.png"),new o("assets/images/digit1.png"),new o("assets/images/digit2.png"),new o("assets/images/digit3.png"),new o("assets/images/digit4.png"),new o("assets/images/digit5.png"),new o("assets/images/digit6.png"),new o("assets/images/digit7.png"),new o("assets/images/digit8.png"),new o("assets/images/digit9.png"),new o("assets/images/digit-negative.png")];this.isDirty=!0;this.isNegative=!1;this.digits=[];this.digits=this.separateDigits(t)}set value(t){t<0&&(this.isNegative=!0),this.digits=this.separateDigits(Math.abs(t)),this.invalidate()}get value(){return parseInt(this.digits.join(""))}get offText(){return"8".repeat(this.displaySize)}separateDigits(t,e="0"){return t.toString().padStart(this.displaySize,e).split("").map(i=>parseInt(i))}setup(){return m(this,null,function*(){yield Promise.all(this.sprites.map(t=>t.setup()))})}invalidate(){this.isDirty=!0}resize(t,e){this.bounds=t,this.invalidate()}render(t){if(!this.isDirty)return;this.isDirty=!1,z(t,this.bounds,E,w,P,tt);let e=(this.bounds.width-E*2-M*2)/this.displaySize,i=this.bounds.height-E*2-M*2;for(let s=0;s<this.displaySize;s++){let n=this.digits[s],c=this.sprites[n];s===0&&this.isNegative&&(c=this.sprites[10]);let d=this.bounds.x+E+M+s*e,f=this.bounds.y+E+M;c.render(t,d,f,e,i)}}};var R=class{constructor(t,e){this.x=t;this.y=e;this.isBomb=!1;this.isFlagged=!1;this.isRevealed=!1;this.isHighlighted=!1;this.neighbors=0}static setup(){return m(this,null,function*(){yield Promise.all(R.spriteNumbers.map(t=>t.setup())),yield R.spriteFlag.setup(),yield R.spriteMine.setup()})}get position(){return new a(this.x,this.y)}render(t,e){this.isHighlighted&&(t.fillStyle="rgba(255, 0, 0, 1)",t.fillRect(e.x,e.y,e.width,e.height)),this.isRevealed?(t.strokeStyle=w,t.lineWidth=1,t.strokeRect(e.x,e.y,e.width,e.height),this.isBomb?R.spriteMine.render(t,e.x,e.y,e.width,e.height):this.neighbors>0&&R.spriteNumbers[this.neighbors-1].render(t,e.x,e.y,e.width,e.height)):(S(t,e,Q),this.isFlagged&&R.spriteFlag.render(t,e.x,e.y,e.width,e.height))}},y=R;y.spriteMine=new o("assets/images/mine.png",!0),y.spriteFlag=new o("assets/images/flag.png",!0),y.spriteNumbers=[new o("assets/images/number1.png",!0),new o("assets/images/number2.png",!0),new o("assets/images/number3.png",!0),new o("assets/images/number4.png",!0),new o("assets/images/number5.png",!0),new o("assets/images/number6.png",!0),new o("assets/images/number7.png",!0),new o("assets/images/number8.png",!0)];var V=class{constructor(t,e){this.columns=t;this.rows=e;this.flaggedCount=0;this.bombCount=0;this.generate()}isBomb(t){let e=this.getCell(t);if(!e)throw new Error("Invalid cell");return e.isBomb}toggleFlag(t){let e=this.getCell(t);if(!e)throw new Error("Invalid cell");e.isFlagged=!e.isFlagged,e.isFlagged?this.flaggedCount++:this.flaggedCount--}filterCells(t){let e=[];for(let i=0;i<this.rows;i++)for(let s=0;s<this.columns;s++){let n=this.getCell(s,i);if(!n)throw new Error("Invalid cell");t(n)&&e.push(n)}return e}getCell(t,e=void 0){let i,s=0;if(typeof t=="number"&&typeof e=="number")i=t,s=e;else if(t instanceof a&&e===void 0)i=t.x,s=t.y;else throw new Error("Invalid arguments");return i<0||i>=this.columns||s<0||s>=this.rows?null:this.cells[s][i]}generate(){this.cells=[],this.bombCount=0,this.flaggedCount=0,h.info("Grid",`Generating grid ${this.columns}x${this.rows}...`);for(let t=0;t<this.rows;t++){this.cells[t]=[];for(let e=0;e<this.columns;e++)this.cells[t][e]=new y(e,t)}}placeBombs(t,e){h.info("StatePlay",`Placing ${e} bombs avoiding ${t} in a radius of ${F}...`);for(let i=0;i<e;i++){let s=Math.floor(Math.random()*this.rows),n=Math.floor(Math.random()*this.columns),c=Math.ceil(Math.distance(t.x,t.y,n,s)),d=this.getCell(n,s);if(!d||d.isBomb||c<F){i--;continue}d.isBomb=!0,this.bombCount++}}clearCells(t){let e=this.getCell(t);if(!e)throw new Error("Invalid cell");if(e.isRevealed||e.isFlagged)return;e.isRevealed=!0;let i=this.getNeighbors(t),s=i.filter(n=>n.isBomb).length;e.neighbors=s,s===0?(h.debug("StatePlay","No bombs in the neighborhood, clearing neighbors..."),i.forEach(n=>this.clearCells(new a(n.x,n.y)))):h.debug("StatePlay",`Found ${s} bombs in the neighborhood`)}revealBombs(){h.info("StatePlay","Revealing all bombs...");for(let t=0;t<this.rows;t++)for(let e=0;e<this.columns;e++){let i=this.getCell(e,t);if(!i)throw new Error("Invalid cell");i.isBomb&&(i.isRevealed=!0)}}highlightCell(t){let e=this.getCell(t);if(!e)throw new Error("Invalid cell");e.isHighlighted=!0}getNeighbors(t){let e=[];for(let i=-1;i<=1;i++)for(let s=-1;s<=1;s++){let n=this.getCell(new a(t.x+s,t.y+i));!n||e.push(n)}return e}render(t,e){for(let i=0;i<this.rows;i++)for(let s=0;s<this.columns;s++){let n=this.getCell(s,i);if(!n)throw new Error("Invalid cell");n.render(t,new p(e.x+s*e.width,e.y+i*e.height,e.width,e.height))}}};var _=class{constructor(){this.isRunning=!1;this.timer=0}get value(){return Math.floor(this.timer)}reset(){this.timer=0,this.isRunning=!1}start(){this.isRunning=!0}stop(){this.isRunning=!1}update(t){!this.isRunning||(this.timer+=t)}};var G=class{constructor(){this.isDirty=!1;this.isPressed=!1;this.isHovered=!1;this.listeners=[]}setup(){return m(this,null,function*(){})}resize(t){this.bounds=t}update(t){let e=u.mouse;if(this.bounds.contains(e))if(this.isHovered||this.invalidate(),this.isHovered=!0,u.isMouseButtonDown(0))this.isPressed||this.invalidate(),this.isPressed=!0;else{if(this.isPressed){this.invalidate();for(let i of this.listeners)i(this)}this.isPressed=!1}else(this.isPressed||this.isHovered)&&this.invalidate(),this.isPressed=!1,this.isHovered=!1}render(t){!this.isDirty||(this.isDirty=!1,this.isPressed?I(t,this.bounds,l*.75):S(t,this.bounds,l*.75),this.isHovered&&(t.strokeStyle=w,t.lineWidth=1*b,t.strokeRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height)))}addOnButtonPressedListener(t){this.listeners.push(t)}invalidate(){this.isDirty=!0}};var N=class extends G{constructor(){super();this.face=0;this.faces=[new o("assets/images/face-happy.png",!0),new o("assets/images/face-cool.png",!0),new o("assets/images/face-dead.png",!0),new o("assets/images/face-surprised.png",!0)]}setup(){return m(this,null,function*(){yield Promise.all(this.faces.map(e=>e.setup()))})}render(e){if(!this.isDirty)return;super.render(e),e.save(),this.isPressed&&e.translate(1,1);let i=this.faces[this.face],s=Math.min(this.bounds.width,this.bounds.height)-l*2;i.render(e,this.bounds.x+this.bounds.width/2-s/2,this.bounds.y+this.bounds.height/2-s/2,s,s),e.restore()}};var $=class{constructor(t){this.main=t;this.screen={width:0,height:0};this.cellSize=H;this.difficulty=j.EASY;this.timer=new _;this.isRunning=!0;this.isDirty=!1;this.previewCell=null;this.faceButton=new N;this.bombCounterDisplay=new A(this.difficulty.bombs),this.timerDisplay=new A(0),this.faceButton.addOnButtonPressedListener(this.onFaceButtonPressed.bind(this))}get position(){return new a(this.main.canvas.width/2-this.screen.width/2,this.main.canvas.height/2-this.screen.height/2)}get bounds(){return new p(this.position.x,this.position.y,this.screen.width,this.screen.height)}setup(){return m(this,null,function*(){this.grid=new V(this.difficulty.columns,this.difficulty.rows),yield this.faceButton.setup(),yield this.bombCounterDisplay.setup(),yield this.timerDisplay.setup(),yield y.setup(),this.invalidate()})}start(t){h.info("StatePlay","Starting game!"),this.isRunning=!0,this.timer.start(),this.grid.placeBombs(t,this.difficulty.bombs),this.grid.clearCells(t),this.invalidate()}reset(){this.isRunning=!0,this.invalidate(),this.timer.reset(),this.bombCounterDisplay.value=this.difficulty.bombs,this.timerDisplay.value=0}resize(){this.cellSize=Math.min(H,(this.main.canvas.width-g*4-l*2)/this.difficulty.columns,(this.main.canvas.height-g*6-k-l*2)/this.difficulty.rows),this.screen.width=this.cellSize*this.difficulty.columns+g*2+l*2,this.screen.height=this.cellSize*this.difficulty.rows+g*3+k+l*2,this.headerBounds=new p(this.position.x+g,this.position.y+g,this.screen.width-g*2,k),this.boardBounds=new p(this.position.x+g,this.position.y+g+this.headerBounds.height+g,this.screen.width-g*2,this.screen.height-g*3-this.headerBounds.height);let t={width:this.cellSize*2,height:this.headerBounds.height-l*2-x*2},e=1/3;t.width/t.height<e?t.width=t.height*e:t.height=t.width/e,t={width:Math.clamp(t.width,0,this.screen.width),height:Math.clamp(t.height,0,this.headerBounds.height-l*2-x*2)};let i=this.headerBounds.y+l+x;this.bombCounterDisplay.resize(new p(this.headerBounds.x+l+x,i,t.width,t.height),this.main.canvas.context),this.timerDisplay.resize(new p(this.headerBounds.x+this.headerBounds.width-l-t.width-x,i,t.width,t.height),this.main.canvas.context);let s=Math.min(this.headerBounds.height-l*2-x*2,this.screen.width/3);this.faceButton.resize(new p(this.headerBounds.x+this.headerBounds.width/2-s/2,this.headerBounds.y+this.headerBounds.height/2-s/2,s,s)),this.invalidate()}getMouseCoordinates(){let t=u.mouse,e=new a(Math.clamp(Math.floor((t.x-this.boardBounds.x)/this.cellSize),0,this.difficulty.columns-1),Math.clamp(Math.floor((t.y-this.boardBounds.y)/this.cellSize),0,this.difficulty.rows-1));return this.boardBounds.contains(t)?e:null}update(t){return m(this,null,function*(){yield this.handleInput(t),this.isRunning&&(this.timer.update(t),this.timerDisplay.value=this.timer.value,this.bombCounterDisplay.value=this.difficulty.bombs-this.grid.flaggedCount)})}handleInput(t){return m(this,null,function*(){let e=this.getMouseCoordinates();this.isRunning&&e&&(this.updatePreviewCell(e),u.isMouseButtonJustReleased(0)?(this.previewCell=null,this.grid.bombCount<=0?this.start(e):this.grid.isBomb(e)?this.onGameOver(e):this.grid.clearCells(e),this.invalidate()):u.isMouseButtonJustPressed(2)&&this.onFlagCell(e)),this.faceButton.update(t)})}onFlagCell(t){this.grid.toggleFlag(t),this.grid.flaggedCount===this.grid.bombCount&&this.grid.filterCells(e=>e.isBomb&&e.isFlagged).length===this.grid.bombCount&&this.onGameWin(),this.invalidate()}updatePreviewCell(t){if(u.isMouseButtonDown(0)){let e=this.grid.getCell(t);e&&!e.isRevealed?(this.previewCell=new y(e.x,e.y),this.previewCell.isRevealed=!0,this.faceButton.face=3,this.invalidate()):(this.previewCell=null,this.invalidate())}else this.faceButton.face=0}onGameOver(t){h.info("StatePlay","Game over!"),this.isRunning=!1,this.grid.revealBombs(),this.grid.highlightCell(t),this.timer.stop(),this.faceButton.face=2}onGameWin(){h.info("StatePlay","You won!"),this.isRunning=!1,this.grid.revealBombs(),this.timer.stop(),this.bombCounterDisplay.value=0,this.faceButton.face=1}render(t){this.isDirty&&(this.isDirty=!1,this.main.canvas.clear(),S(t,this.bounds,l),I(t,this.headerBounds,l),I(t,this.boardBounds,l),this.renderGrid(t)),this.faceButton.render(t),this.bombCounterDisplay.render(t),this.timerDisplay.render(t)}renderGrid(t){let e=new p(this.boardBounds.x+l,this.boardBounds.y+l,this.cellSize,this.cellSize);this.grid.render(t,e),this.previewCell!==null&&(t.fillStyle=B,t.strokeStyle=w,t.lineWidth=1*b,t.beginPath(),t.rect(e.x+this.previewCell.x*e.width,e.y+this.previewCell.y*e.height,e.width,e.height),t.closePath(),t.fill(),t.stroke())}invalidate(){this.isDirty=!0,this.timerDisplay.invalidate(),this.bombCounterDisplay.invalidate(),this.faceButton.invalidate()}onFaceButtonPressed(){this.faceButton.face=0,this.grid.generate(),this.reset()}};var U=class{constructor(t,e){this.rect=t;this.color=e}render(t){t.strokeStyle=this.color,t.lineWidth=1,t.strokeRect(this.rect.x,this.rect.y,this.rect.width,this.rect.height)}},W=class{constructor(t,e){this.rect=t;this.color=e}render(t){t.fillStyle=this.color,t.fillRect(this.rect.x,this.rect.y,this.rect.width,this.rect.height)}},J=class{constructor(t,e,i,s){this.start=t;this.end=e;this.color=i;this.thickness=s}render(t){t.strokeStyle=this.color,t.lineWidth=this.thickness,t.beginPath(),t.moveTo(this.start.x,this.start.y),t.lineTo(this.end.x,this.end.y),t.stroke()}},Y=class{constructor(t,e,i){this.center=t;this.radius=e;this.color=i}render(t){t.fillStyle=this.color,t.lineWidth=1,t.beginPath(),t.arc(this.center.x,this.center.y,this.radius,0,Math.PI*2),t.fill()}},q=class{constructor(t,e,i,s){this.text=t;this.position=e;this.color=i;this.alignment=s}render(t){t.fillStyle=this.color,t.font="12px Arial",t.textAlign=this.alignment,t.fillText(this.text,this.position.x,this.position.y)}},X=class{constructor(t,e,i){this.origin=t;this.vector=e;this.color=i;this.ARROWHEAD_LENGTH=10;this.ARROWHEAD_ANGLE=Math.PI/6;this.MIN_LENGTH=1;this.MAX_LENGTH=100}render(t){let e=this.vector.length;if(e<this.MIN_LENGTH)return;e>this.MAX_LENGTH&&(this.vector=this.vector.normalize().multiply(this.MAX_LENGTH),e=this.MAX_LENGTH);let i=(e-this.MIN_LENGTH)/(this.MAX_LENGTH-this.MIN_LENGTH),s=L.alpha(this.color,i);t.fillStyle=s,t.strokeStyle=s,t.lineWidth=1.5,t.lineCap="round",t.beginPath(),t.moveTo(this.origin.x,this.origin.y),t.lineTo(this.origin.x+this.vector.x,this.origin.y+this.vector.y),t.stroke();let n=10,c=Math.PI/6,d=Math.atan2(this.vector.y,this.vector.x);t.beginPath(),t.moveTo(this.origin.x+this.vector.x,this.origin.y+this.vector.y),t.lineTo(this.origin.x+this.vector.x-n*Math.cos(d-c),this.origin.y+this.vector.y-n*Math.sin(d-c)),t.lineTo(this.origin.x+this.vector.x-n*Math.cos(d+c),this.origin.y+this.vector.y-n*Math.sin(d+c)),t.lineTo(this.origin.x+this.vector.x,this.origin.y+this.vector.y),t.fill()}},C=class{static render(t){for(let e of C.list)e.render(t)}static clear(){C.list=[]}static rect(t,e="#fff"){C.list.push(new W(t,e))}static outline(t,e="#fff"){C.list.push(new U(t,e))}static line(t,e,i="#fff",s=1){C.list.push(new J(t,e,i,s))}static circle(t,e,i="#fff"){C.list.push(new Y(t,e,i))}static text(t,e,i="#fff",s="left"){C.list.push(new q(t,e,i,s))}static arrow(t,e,i="#fff"){C.list.push(new X(t,e,i))}},O=C;O.list=[];var K=class{constructor(){this.canvas=new T("canvas");this.ctx=this.canvas.context;this.handleAnimationFrameRequest=-1;this.lastFrameTime=performance.now();this.state=new $(this);this.globalTimer=0;h.info("Main","Starting up..."),this.attachHooks(),v.setup(this)}attachHooks(){h.info("Main","Attaching hooks..."),window.addLoadEventListener(this.onLoad.bind(this)),window.addVisibilityChangeEventListener(this.onVisibilityChange.bind(this)),window.addEventListener("resize",this.onResize.bind(this)),u.setup(this)}onLoad(){return m(this,null,function*(){h.debug("Main","Window loaded"),this.canvas.attachToElement(document.body),this.onResize(),yield this.state.setup(),this.requestNextFrame()})}onVisibilityChange(t){h.info("Main",`Window visibility changed to ${t?"visible":"hidden"}`),t?this.requestNextFrame():this.handleAnimationFrameRequest!=-1&&cancelAnimationFrame(this.handleAnimationFrameRequest)}onResize(){h.debug("Main","Window resized"),this.canvas.setSize(window.innerWidth,window.innerHeight),this.state.resize()}requestNextFrame(){this.handleAnimationFrameRequest=requestAnimationFrame(this.loop.bind(this))}loop(t){return m(this,null,function*(){let e=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t,yield this.state.update(e),u.update(),this.state.render(this.ctx),O.render(this.ctx),this.requestNextFrame()})}};window._instance=new K;})();
